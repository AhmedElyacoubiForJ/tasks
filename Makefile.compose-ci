# 📁 Makefile.compose-ci

# In ci.yml run: make -f Makefile.compose-ci ci-dev-up
# make -f Makefile.compose-ci ci-dev-down
# - name: 🧪 Healthcheck
#  run: make -f Makefile.compose-ci ci-dev-healthcheck
#
# - name: 📋 Tasklist-Check
#  run: make -f Makefile.compose-ci ci-dev-tasklist-check

ROOT := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
COMPOSE_CI := $(ROOT)/scripts/compose-ci
COMPOSE := $(ROOT)/scripts/compose-dev

# 🧭 Pfadprüfung
ci-print-path:
	@echo "📁 ROOT         = $(ROOT)"
	@echo "📁 COMPOSE_CI   = $(COMPOSE_CI)"
	@echo "📁 COMPOSE      = $(COMPOSE)"

# 🆘 Hilfe für CI-Targets
ci-help:
	@echo "🛠️  CI-spezifische Makefile Targets:"
	@grep -E '^ci-[a-zA-Z_-]+:' $(lastword $(MAKEFILE_LIST)) | awk 'BEGIN {FS = ":"}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, "→ CI-spezifischer Befehl"}'

# make -f Makefile.compose-ci ci-print-path
# make -f Makefile.compose-ci ci-help


# 🔧 CI-spezifische Targets
ci-dev-up:
	docker compose -f docker-compose-dev-ci.yml up -d

ci-dev-down:
	@echo "🔄 Stoppe Umgebung und entferne alles..."
	docker compose -f docker-compose-dev-ci.yml down -v

ci-dev-logs:
	docker compose -f docker-compose-dev-ci.yml logs --no-color

ci-dev-ps:
	@echo "🐙 Zeige Compose-Container..."
	docker compose -f docker-compose-dev-ci.yml ps -a

ci-dev-ps-watch:
	@set -x; \
    for i in $(seq 1 10); do \
        #echo "⏱️  Versuch $$i: docker compose ps -a"; \
        echo "::notice title=Versuch $$i::docker compose ps -a" \
        docker compose -f docker-compose-dev-ci.yml ps -a || echo "❌ Fehler beim Abrufen"; \
        sleep 5; \
    done


ci-dev-healthcheck:
	@echo "🔍 Prüfe App-Verfügbarkeit..."
	#docker exec tasks-app curl --fail --silent --show-error http://localhost:8080/actuator/health || (echo "❌ App nicht erreichbar!" && exit 1)
	docker exec tasks-app curl --fail --silent --show-error http://127.0.0.1:8080/actuator/health || (echo "❌ App nicht erreichbar!" && exit 1)


ci-dev-healthcheck-retry:
	@echo "🔄 Warte auf App im Container..."
	@for i in {1..10}; do \
        docker exec tasks-app curl --fail --silent --show-error http://localhost:8080/actuator/health && echo "✅ App erreichbar!" && exit 0; \
        echo "⏳ Versuch $$i fehlgeschlagen, warte..."; \
        sleep 3; \
    done; \
    echo "❌ App nicht erreichbar nach 10 Versuchen!" && exit 1


ci-dev-tasklist-check:
	@echo "📋 Prüfe /task-lists/details..."
	@curl --fail --silent --show-error http://127.0.0.1:8080/task-lists/details | grep '"status":"success"' > /dev/null \
        && echo "✅ TaskList-Endpunkt erfolgreich!" \
        || (echo "❌ TaskList-Endpunkt fehlgeschlagen!" && exit 1)


ci-dev-debug:
	@echo "🌐 Versuche Verbindung zu App..."
	curl -v http://127.0.0.1:8080/actuator/health || echo "❌ Verbindung fehlgeschlagen"

ci-dev-process-watch:
	@echo "🔍 Überwache App-Prozess im Container..."
	@for i in $(seq 1 20); do \
        echo "⏱️  Versuch $$i: Prüfe Prozessliste..."; \
        docker exec tasks-app ps aux | grep "java -jar app.jar" && echo "✅ App-Prozess läuft!" && exit 0; \
        echo "⏳ Prozess nicht gefunden, warte..."; \
        sleep 5; \
    done; \
    echo "❌ App-Prozess nicht stabil nach 20 Versuchen!" && exit 1


ci-dev-verify:
	@make -f Makefile.compose-ci ci-dev-healthcheck-retry
	@make -f Makefile.compose-ci ci-dev-tasklist-check


# ➡️ $MAKE ist die aktuelle make-Instanz
# ➡️ $(MAKEFILE_LIST) ist der Pfad zum aktuellen Makefile
#ci-dev-verify:
#	@$(MAKE) -f $(MAKEFILE_LIST) ci-dev-healthcheck-retry
#	@$(MAKE) -f $(MAKEFILE_LIST) ci-dev-tasklist-check


ci-dev-clean:
	@echo "🧹 Entferne Volumes..."
	@docker volume rm tasks_pgdata-dev || echo "⚠️ Volume nicht vorhanden"

#ci-release-check:
#	@echo "🚀 Prüfe Release-Bereitschaft..."
#	@curl --fail --silent --show-error http://127.0.0.1:8080/actuator/info | grep '"version"' > /dev/null \
#        && echo "✅ Release-Info verfügbar!" \
#        || (echo "❌ Release-Info fehlt!" && exit 1)
#
#
#ci-dev-check-and-release-check:
#	@make -f Makefile.compose-ci ci-dev-verify
#	@curl --fail --silent http://127.0.0.1:8080/actuator/info | grep '"version"' > /dev/null \
#        && echo "✅ Release-Info verfügbar!" \
#        || (echo "❌ Release-Info fehlt!" && exit 1)







# 🔁 Gemeinsame Targets referenzieren
# TODO
#ci-dev-verify:
#	make -f Makefile.compose compose-dev-verify # TODO
#
#ci-dev-lint:
#	make -f Makefile.compose compose-dev-lint   # TODO
#
#ci-dev-reset-db:
#	make -f Makefile.compose compose-dev-reset-db # TODO



#🧩 Nächste Schritte
#
#ci-dev-verify bauen, das App & DB prüft
#
#ci-dev-reset-db ergänzen, falls du DB-Tests brauchst
#
#ci-dev-release-check vorbereiten für spätere Deployment-Logik
#
#Oder ci-help-all bauen, das auch Makefile.compose referenziert
