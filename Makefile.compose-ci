# ğŸ“ Makefile.compose-ci

# In ci.yml run: make -f Makefile.compose-ci ci-dev-up
# make -f Makefile.compose-ci ci-dev-down
# - name: ğŸ§ª Healthcheck
#  run: make -f Makefile.compose-ci ci-dev-healthcheck
#
# - name: ğŸ“‹ Tasklist-Check
#  run: make -f Makefile.compose-ci ci-dev-tasklist-check

ROOT := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
COMPOSE_CI := $(ROOT)/scripts/compose-ci
COMPOSE := $(ROOT)/scripts/compose-dev

# ğŸ§­ PfadprÃ¼fung
ci-print-path:
	@echo "ğŸ“ ROOT         = $(ROOT)"
	@echo "ğŸ“ COMPOSE_CI   = $(COMPOSE_CI)"
	@echo "ğŸ“ COMPOSE      = $(COMPOSE)"

# ğŸ†˜ Hilfe fÃ¼r CI-Targets
ci-help:
	@echo "ğŸ› ï¸  CI-spezifische Makefile Targets:"
	@grep -E '^ci-[a-zA-Z_-]+:' $(lastword $(MAKEFILE_LIST)) | awk 'BEGIN {FS = ":"}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, "â†’ CI-spezifischer Befehl"}'

# make -f Makefile.compose-ci ci-print-path
# make -f Makefile.compose-ci ci-help


# ğŸ”§ CI-spezifische Targets
ci-dev-up:
	docker compose -f docker-compose-dev-ci.yml up -d

ci-dev-down:
	@echo "ğŸ”„ Stoppe Umgebung und entferne alles..."
	docker compose -f docker-compose-dev-ci.yml down -v

ci-dev-logs:
	docker compose -f docker-compose-dev-ci.yml logs --no-color

ci-dev-ps:
	@echo "ğŸ™ Zeige Compose-Container..."
	docker compose -f docker-compose-dev-ci.yml ps -a

ci-dev-ps-watch:
	@set -x; \
    for i in $(seq 1 10); do \
        #echo "â±ï¸  Versuch $$i: docker compose ps -a"; \
        echo "::notice title=Versuch $$i::docker compose ps -a" \
        docker compose -f docker-compose-dev-ci.yml ps -a || echo "âŒ Fehler beim Abrufen"; \
        sleep 5; \
    done


ci-dev-healthcheck:
	@echo "ğŸ” PrÃ¼fe App-VerfÃ¼gbarkeit..."
	#docker exec tasks-app curl --fail --silent --show-error http://localhost:8080/actuator/health || (echo "âŒ App nicht erreichbar!" && exit 1)
	docker exec tasks-app curl --fail --silent --show-error http://127.0.0.1:8080/actuator/health || (echo "âŒ App nicht erreichbar!" && exit 1)


ci-dev-healthcheck-retry:
	@echo "ğŸ”„ Warte auf App im Container..."
	@for i in {1..10}; do \
        docker exec tasks-app curl --fail --silent --show-error http://localhost:8080/actuator/health && echo "âœ… App erreichbar!" && exit 0; \
        echo "â³ Versuch $$i fehlgeschlagen, warte..."; \
        sleep 3; \
    done; \
    echo "âŒ App nicht erreichbar nach 10 Versuchen!" && exit 1


ci-dev-tasklist-check:
	@echo "ğŸ“‹ PrÃ¼fe /task-lists/details..."
	@curl --fail --silent --show-error http://127.0.0.1:8080/task-lists/details | grep '"status":"success"' > /dev/null \
        && echo "âœ… TaskList-Endpunkt erfolgreich!" \
        || (echo "âŒ TaskList-Endpunkt fehlgeschlagen!" && exit 1)


ci-dev-debug:
	@echo "ğŸŒ Versuche Verbindung zu App..."
	curl -v http://127.0.0.1:8080/actuator/health || echo "âŒ Verbindung fehlgeschlagen"

ci-dev-process-watch:
	@echo "ğŸ” Ãœberwache App-Prozess im Container..."
	@for i in $(seq 1 20); do \
        echo "â±ï¸  Versuch $$i: PrÃ¼fe Prozessliste..."; \
        docker exec tasks-app ps aux | grep "java -jar app.jar" && echo "âœ… App-Prozess lÃ¤uft!" && exit 0; \
        echo "â³ Prozess nicht gefunden, warte..."; \
        sleep 5; \
    done; \
    echo "âŒ App-Prozess nicht stabil nach 20 Versuchen!" && exit 1


ci-dev-verify:
	@make -f Makefile.compose-ci ci-dev-healthcheck-retry
	@make -f Makefile.compose-ci ci-dev-tasklist-check


# â¡ï¸ $MAKE ist die aktuelle make-Instanz
# â¡ï¸ $(MAKEFILE_LIST) ist der Pfad zum aktuellen Makefile
#ci-dev-verify:
#	@$(MAKE) -f $(MAKEFILE_LIST) ci-dev-healthcheck-retry
#	@$(MAKE) -f $(MAKEFILE_LIST) ci-dev-tasklist-check


ci-dev-clean:
	@echo "ğŸ§¹ Entferne Volumes..."
	@docker volume rm tasks_pgdata-dev || echo "âš ï¸ Volume nicht vorhanden"

#ci-release-check:
#	@echo "ğŸš€ PrÃ¼fe Release-Bereitschaft..."
#	@curl --fail --silent --show-error http://127.0.0.1:8080/actuator/info | grep '"version"' > /dev/null \
#        && echo "âœ… Release-Info verfÃ¼gbar!" \
#        || (echo "âŒ Release-Info fehlt!" && exit 1)
#
#
#ci-dev-check-and-release-check:
#	@make -f Makefile.compose-ci ci-dev-verify
#	@curl --fail --silent http://127.0.0.1:8080/actuator/info | grep '"version"' > /dev/null \
#        && echo "âœ… Release-Info verfÃ¼gbar!" \
#        || (echo "âŒ Release-Info fehlt!" && exit 1)







# ğŸ” Gemeinsame Targets referenzieren
# TODO
#ci-dev-verify:
#	make -f Makefile.compose compose-dev-verify # TODO
#
#ci-dev-lint:
#	make -f Makefile.compose compose-dev-lint   # TODO
#
#ci-dev-reset-db:
#	make -f Makefile.compose compose-dev-reset-db # TODO



#ğŸ§© NÃ¤chste Schritte
#
#ci-dev-verify bauen, das App & DB prÃ¼ft
#
#ci-dev-reset-db ergÃ¤nzen, falls du DB-Tests brauchst
#
#ci-dev-release-check vorbereiten fÃ¼r spÃ¤tere Deployment-Logik
#
#Oder ci-help-all bauen, das auch Makefile.compose referenziert
